<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®ç­”ç»Ÿè®¡ - æ¥å£AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-xl font-bold text-blue-600">æ¥å£AI</span>
                <span class="text-gray-500">é—®ç­”ç»Ÿè®¡</span>
            </div>
            <a href="/" class="text-gray-600 hover:text-blue-600">è¿”å›é—®ç­”</a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- æ¦‚è§ˆå¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500">æ€»é—®é¢˜æ•°</div>
                <div id="totalQuestions" class="text-3xl font-bold text-blue-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500">æ”¶åˆ°è¯„ä»·</div>
                <div id="totalFeedback" class="text-3xl font-bold text-purple-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500">æœ‰ç”¨ç‡</div>
                <div id="helpfulRate" class="text-3xl font-bold text-green-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500">å¹³å‡å“åº”æ—¶é—´</div>
                <div id="avgResponseTime" class="text-3xl font-bold text-orange-600">-</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- è¶‹åŠ¿å›¾ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-700 mb-4">æœ€è¿‘ 7 å¤©è¶‹åŠ¿</h3>
                <canvas id="trendChart" height="200"></canvas>
            </div>

            <!-- è¯„ä»·åˆ†å¸ƒ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-700 mb-4">è¯„ä»·åˆ†å¸ƒ</h3>
                <canvas id="feedbackChart" height="200"></canvas>
            </div>
        </div>

        <!-- çƒ­é—¨é—®é¢˜ -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-medium text-gray-700 mb-4">çƒ­é—¨é—®é¢˜ TOP 10</h3>
            <div id="hotQuestions" class="space-y-3"></div>
            <div id="noHotQuestions" class="hidden text-center text-gray-400 py-8">
                æš‚æ— æ•°æ®
            </div>
        </div>

        <!-- å†å²é—®é¢˜ -->
        <div class="bg-white rounded-lg shadow p-6">
            <!-- æ ‡é¢˜æ  -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-700">å†å²é—®é¢˜</h3>
                <div class="flex items-center space-x-4 text-sm">
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500">æ¯é¡µ</span>
                        <select id="pageSize" onchange="changePageSize()" class="border border-gray-300 rounded px-2 py-1 text-gray-700">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <span class="text-gray-500">æ¡</span>
                    </div>
                    <span id="historyTotalCount" class="text-gray-500">å…± - æ¡</span>
                </div>
            </div>

            <!-- åˆ—è¡¨ -->
            <div id="historyList" class="divide-y divide-gray-100"></div>

            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="pagination" class="hidden flex justify-center items-center space-x-4 mt-4 pt-4 border-t text-sm">
                <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">
                    &lt; ä¸Šä¸€é¡µ
                </button>
                <span class="text-gray-600">ç¬¬ <span id="currentPage">1</span> é¡µ / å…± <span id="totalPages">1</span> é¡µ</span>
                <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">
                    ä¸‹ä¸€é¡µ &gt;
                </button>
            </div>

            <div id="noHistory" class="hidden text-center text-gray-400 py-8">
                æš‚æ— å†å²è®°å½•
            </div>
        </div>
    </main>

    <script>
        let trendChart = null;
        let feedbackChart = null;

        // HTML è½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢ XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åŠ è½½æ¦‚è§ˆæ•°æ®
        async function loadOverview() {
            try {
                const response = await fetch('/api/stats/overview');
                const data = await response.json();

                document.getElementById('totalQuestions').textContent = data.total_questions;
                document.getElementById('totalFeedback').textContent = data.total_feedback;
                totalRecords = data.total_questions;  // ç”¨äºå†å²é—®é¢˜åˆ†é¡µ
                document.getElementById('helpfulRate').textContent = data.helpful_rate + '%';
                document.getElementById('avgResponseTime').textContent = (data.avg_response_time_ms / 1000).toFixed(1) + 's';

                // æ›´æ–°è¯„ä»·åˆ†å¸ƒå›¾
                updateFeedbackChart(data.helpful_count, data.not_helpful_count);

            } catch (error) {
                console.error('åŠ è½½æ¦‚è§ˆå¤±è´¥:', error);
            }
        }

        // åŠ è½½è¶‹åŠ¿æ•°æ®
        async function loadDailyStats() {
            try {
                const response = await fetch('/api/stats/daily?days=7');
                const data = await response.json();

                updateTrendChart(data.reverse());

            } catch (error) {
                console.error('åŠ è½½è¶‹åŠ¿å¤±è´¥:', error);
            }
        }

        // åŠ è½½çƒ­é—¨é—®é¢˜
        async function loadHotQuestions() {
            try {
                const response = await fetch('/api/stats/hot_questions?limit=10');
                const data = await response.json();

                const container = document.getElementById('hotQuestions');
                const noData = document.getElementById('noHotQuestions');

                if (data.length === 0) {
                    container.classList.add('hidden');
                    noData.classList.remove('hidden');
                    return;
                }

                container.innerHTML = data.map((q, i) => `
                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <span class="text-lg font-bold text-gray-400">${i + 1}</span>
                            <span class="text-gray-700">${escapeHtml(q.question)}</span>
                        </div>
                        <span class="text-sm text-gray-500">${q.count} æ¬¡</span>
                    </div>
                `).join('');

            } catch (error) {
                console.error('åŠ è½½çƒ­é—¨é—®é¢˜å¤±è´¥:', error);
            }
        }

        // å†å²é—®é¢˜åˆ†é¡µ
        let currentPage = 1;
        let pageSize = 10;
        let totalRecords = 0;

        // åŠ è½½å†å²é—®é¢˜
        async function loadHistoryPage() {
            try {
                const offset = (currentPage - 1) * pageSize;
                const response = await fetch(`/api/qa/history?limit=${pageSize}&offset=${offset}`);
                const data = await response.json();

                const container = document.getElementById('historyList');
                const noData = document.getElementById('noHistory');
                const pagination = document.getElementById('pagination');

                if (data.length === 0 && currentPage === 1) {
                    container.innerHTML = '';
                    pagination.classList.add('hidden');
                    noData.classList.remove('hidden');
                    return;
                }

                noData.classList.add('hidden');
                pagination.classList.remove('hidden');

                // è®¡ç®—åºå·èµ·å§‹å€¼ï¼ˆå€’åºæ˜¾ç¤ºï¼‰
                const startIndex = offset + 1;

                container.innerHTML = data.map((record, i) => `
                    <div class="flex items-center py-2 hover:bg-gray-50 text-sm">
                        <span class="w-10 text-gray-400 text-right mr-3">${startIndex + i}</span>
                        <span class="flex-1 text-gray-700 truncate" title="${escapeHtml(record.question)}">${escapeHtml(record.question)}</span>
                        <span class="w-20 text-gray-400 text-right">${formatTime(record.created_at)}</span>
                        <span class="w-16 text-gray-400 text-right">${((record.response_time_ms || 0) / 1000).toFixed(1)}s</span>
                        <span class="w-20 text-right ${getFeedbackColor(record.feedback)}">${getFeedbackText(record.feedback)}</span>
                    </div>
                `).join('');

                updatePagination();

            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 86400000);

            if (date >= today) {
                return date.toTimeString().slice(0, 5);
            } else if (date >= yesterday) {
                return 'æ˜¨å¤©';
            } else {
                return (date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0');
            }
        }

        // è·å–è¯„ä»·é¢œè‰²
        function getFeedbackColor(feedback) {
            if (feedback === null) return 'text-gray-400';
            return feedback ? 'text-green-500' : 'text-orange-500';
        }

        // è·å–è¯„ä»·æ–‡æœ¬
        function getFeedbackText(feedback) {
            if (feedback === null) return 'æœªè¯„ä»·';
            return feedback ? 'ğŸ‘ æœ‰ç”¨' : 'âœï¸ éœ€æ”¹è¿›';
        }

        // æ›´æ–°åˆ†é¡µçŠ¶æ€
        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('historyTotalCount').textContent = `å…± ${totalRecords} æ¡`;

            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadHistoryPage();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                loadHistoryPage();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            loadHistoryPage();
        }

        // æ›´æ–°è¶‹åŠ¿å›¾
        function updateTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date.substring(5)),
                    datasets: [{
                        label: 'é—®é¢˜æ•°',
                        data: data.map(d => d.questions),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'æœ‰ç”¨',
                        data: data.map(d => d.helpful),
                        borderColor: '#22c55e',
                        backgroundColor: 'transparent',
                        tension: 0.3
                    }, {
                        label: 'æ²¡ç”¨',
                        data: data.map(d => d.not_helpful),
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // æ›´æ–°è¯„ä»·åˆ†å¸ƒå›¾
        function updateFeedbackChart(helpful, notHelpful) {
            const ctx = document.getElementById('feedbackChart').getContext('2d');

            if (feedbackChart) feedbackChart.destroy();

            feedbackChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['æœ‰ç”¨', 'æ²¡ç”¨'],
                    datasets: [{
                        data: [helpful, notHelpful],
                        backgroundColor: ['#22c55e', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // é¡µé¢åŠ è½½
        loadOverview().then(() => loadHistoryPage());  // å…ˆåŠ è½½æ¦‚è§ˆè·å–æ€»æ•°ï¼Œå†åŠ è½½å†å²
        loadDailyStats();
        loadHotQuestions();
    </script>
</body>
</html>
